<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>SENTINEL | è´¢åŠ¡èµ„äº§å®¡è®¡çœ‹æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; }
        .glass-card { background: #161b22; border: 1px solid #30363d; border-radius: 12px; }
        .stat-value { font-family: 'Segoe UI', monospace; }
    </style>
</head>
<body class="p-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-end mb-8 border-b border-gray-700 pb-4">
            <div class="flex items-center gap-4">
                <a href="/" class="text-gray-400 hover:text-blue-400 transition text-sm flex items-center gap-2">
                    â† è¿”å›ä¸»é¡µ
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-blue-400">ğŸ“Š æ¯èˆ°èµ„äº§å…¨æ¯å®¡è®¡</h1>
                    <p class="text-gray-500 text-sm mt-1" id="update_time">æ­£åœ¨è¿æ¥æ¯èˆ°æ•°æ®åº“...</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="autoListMissing()" id="auto_list_btn" class="bg-green-700 hover:bg-green-600 disabled:bg-gray-700 disabled:cursor-not-allowed px-4 py-2 rounded text-sm transition flex items-center gap-2">
                    ğŸš€ ä¸€é”®ä¸Šæ¶
                </button>
                <button onclick="refreshAuditData()" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded text-sm transition">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-card p-6 border-l-4 border-l-red-500">
                <div class="text-gray-500 text-xs uppercase mb-1">é‡‡è´­æ€»æˆæœ¬</div>
                <div id="total_investment" class="text-3xl font-bold stat-value">Â¥ 0.00</div>
            </div>
            <div class="glass-card p-6 border-l-4 border-l-green-500">
                <div class="text-gray-500 text-xs uppercase mb-1 font-bold">ğŸ’° å½“å‰å·²å®ç°åˆ©æ¶¦</div>
                <div id="current_profit" class="text-3xl font-bold stat-value">Â¥ 0.00</div>
            </div>
            <div class="glass-card p-6 border-l-4 border-l-cyan-500">
                <div class="text-gray-500 text-xs uppercase mb-1 font-bold">ğŸ“ˆ æœ€ç»ˆé¢„æœŸæ€»åˆ©æ¶¦</div>
                <div id="expected_profit" class="text-3xl font-bold stat-value">Â¥ 0.00</div>
            </div>

            <div class="glass-card p-6 border-l-4 border-l-blue-500">
                <div class="text-gray-500 text-xs uppercase mb-1">å·²å›æ”¶ç°é‡‘ (åˆ°æ‰‹)</div>
                <div id="realized_cash" class="text-3xl font-bold text-blue-400 stat-value">Â¥ 0.00</div>
            </div>
            <div class="glass-card p-6 border-l-4 border-l-purple-500">
                <div class="text-gray-500 text-xs uppercase mb-1 font-bold">ğŸš€ æŠ•èµ„å›æŠ¥ç‡ (ROI)</div>
                <div class="flex flex-col gap-1">
                    <div id="sold_roi" class="text-3xl font-bold text-purple-400 stat-value">0.00%</div>
                    <div class="text-xs text-gray-500">é¢„æœŸå…¨ç›˜ï¼š<span id="exp_roi" class="text-gray-400">0%</span></div>
                </div>
            </div>
            <div class="glass-card p-6 border-l-4 border-l-yellow-500">
                <div class="text-gray-500 text-xs uppercase mb-1">è´§æ¶æ€»å‡€å€¼</div>
                <div id="floating_asset" class="text-3xl font-bold text-yellow-500 stat-value">Â¥ 0.00</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 glass-card p-6">
                <h3 class="text-lg font-bold mb-4 text-gray-300">ğŸ•’ è´§æ¶è´¦é¾„åˆ†æ</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-gray-500 border-b border-gray-800">
                            <tr>
                                <th class="pb-3">æ¸¸æˆå®ä½“</th>
                                <th class="pb-3">æŒ‚å•ä»·</th>
                                <th class="pb-3 text-right">å·²æŒ‚æ—¶é•¿</th>
                            </tr>
                        </thead>
                        <tbody id="aging_body"></tbody>
                    </table>
                </div>
            </div>

            <div class="glass-card p-6">
                <h3 class="text-lg font-bold mb-4 text-yellow-400 flex items-center justify-between">
                    <span>ğŸŸ¡ å¾…å”®å•†å“ (æœªä¸Šæ¶)</span>
                    <span id="missing_count" class="text-xs bg-yellow-900/50 px-2 py-1 rounded">0 ä¸ª</span>
                </h3>
                <div id="missing_body" class="space-y-3"></div>
            </div>
        </div>

        <!-- ğŸš€ æ–°å¢ï¼šå…¨æ¯èµ„äº§æº¯æºæ¸…å• -->
        <div class="glass-card p-6 mt-8">
            <h3 class="text-lg font-bold mb-4 text-purple-400">ğŸ“‹ å…¨æ¯èµ„äº§æº¯æºæ¸…å• (å…¨é‡äº¤æ˜“æ˜ç»†)</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="text-gray-500 border-b border-gray-800">
                        <tr>
                            <th class="pb-3">çŠ¶æ€</th>
                            <th class="pb-3">é‡‡è´­åç§°</th>
                            <th class="pb-3">æ˜ å°„é”€å”®å</th>
                            <th class="pb-3 text-right">é‡‡è´­æˆæœ¬</th>
                            <th class="pb-3 text-right">é¢„ä¼°æ”¶å…¥</th>
                            <th class="pb-3 text-right">ç›ˆäº</th>
                        </tr>
                    </thead>
                    <tbody id="trace_body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
       // ğŸ“¡ ç½‘é¡µé›·è¾¾ï¼šè®°å½•ä¸Šä¸€æ¬¡æ¯èˆ°å®¡è®¡çš„æ—¶é—´æˆ³
    let lastUpdateAt = "";
    
    // ğŸ” API Tokenï¼ˆå¦‚æœéœ€è¦è®¤è¯ï¼‰- æ°¸ä¹…ä¿å­˜åœ¨ localStorage
    // ç”¨æ³•ï¼šç¬¬ä¸€æ¬¡è®¿é—®æ—¶è¾“å…¥ï¼Œä¹‹åä¼šè‡ªåŠ¨è®°ä½
    const API_TOKEN = localStorage.getItem('sentinel_token') || null;

    async function loadAudit() {
        try {
            const headers = API_TOKEN ? { 'Authorization': `Bearer ${API_TOKEN}` } : {};
            const res = await fetch('/api/audit_stats', { headers });
            
            // ğŸ” 401 æœªæˆæƒå¤„ç† - åªæ˜¾ç¤ºä¸€æ¬¡æç¤º
            if (res.status === 401) {
                // å¦‚æœå·²ç»æœ‰ Token ä½†å¤±æ•ˆäº†ï¼Œæ¸…é™¤å®ƒ
                if (API_TOKEN) {
                    localStorage.removeItem('sentinel_token');
                }
                
                const token = prompt(
                    'ğŸ”’ éœ€è¦è®¿é—®å¯†ç \n\n' +
                    'è¯·è¾“å…¥ API Token'
                );
                
                if (token) {
                    localStorage.setItem('sentinel_token', token);
                    location.reload();
                }
                return;
            }
            
            if (!res.ok) throw new Error("ç½‘ç»œå“åº”å¼‚å¸¸");
            const d = await res.json();

            // ğŸ’¡ æ ¸å¿ƒä¿æŠ¤ï¼šå¦‚æœåç«¯è¿”å›çš„æ—¶é—´æˆ³æ²¡å˜ï¼Œç›´æ¥åˆ‡æ–­åç»­é€»è¾‘ï¼Œç½‘é¡µåŠ¨éƒ½ä¸åŠ¨ä¸€ä¸‹
            if (lastUpdateAt === d.update_at) {
                console.log("ğŸ§Š è´¦æœ¬æœªå˜åŠ¨ï¼Œä¿æŒé™é»˜...");
                return;
            }

            // ğŸ’¡ åªæœ‰æ—¶é—´æˆ³å˜äº†ï¼ˆè¯´æ˜åå°ç®—å®Œæ–°è´¦äº†ï¼‰ï¼Œæ‰å¼€å§‹"è´´çº¸"æ›´æ–°
            console.log(`ğŸš€ ä¾¦æµ‹åˆ°æ–°è´¦æœ¬ [${d.update_at}]ï¼Œæ­£åœ¨æ›´æ–°è§†å›¾...`);
            lastUpdateAt = d.update_at;

            // ğŸ“Š åˆå§‹åŒ– lastTraceDetailsï¼ˆç”¨äºå¢é‡è®¡ç®—ï¼‰
            lastTraceDetails = d.details.trace_details || [];

            // --- ä»¥ä¸‹æ˜¯é™é»˜æ›¿æ¢é€»è¾‘ï¼Œä¸ä¼šå¼•èµ·ç™½å±æˆ–å½’é›¶ ---
            document.getElementById('update_time').innerText = "æœ€åæ¸…ç®—ï¼š" + d.update_at;
            document.getElementById('total_investment').innerText = "Â¥ " + d.summary.total_investment;
            document.getElementById('realized_cash').innerText = "Â¥ " + d.summary.realized_cash;
            document.getElementById('floating_asset').innerText = "Â¥ " + d.summary.floating_asset;

            // ğŸš€ ROI æ•°æ®æ¥é©³ï¼ˆå¸¦ Null å®ˆæŠ¤ï¼‰
            const rawSoldRoi = d.summary.sold_roi ?? 0;
            const rawExpRoi = d.summary.total_expected_roi ?? 0;
            document.getElementById('sold_roi').innerText = rawSoldRoi + "%";
            document.getElementById('exp_roi').innerText = rawExpRoi + "%";

            document.getElementById('current_profit').innerText = "Â¥ " + d.summary.current_profit;
            document.getElementById('expected_profit').innerText = "Â¥ " + d.summary.expected_profit;

            // é¡ºä¾¿åšä¸ªé¢œè‰²é«˜äº®é€»è¾‘ï¼šå¦‚æœåˆ©æ¶¦æ˜¯è´Ÿçš„ï¼ˆè¿˜æ²¡å›æœ¬ï¼‰ï¼Œæ˜¾ç¤ºçº¢è‰²ï¼Œæ­£çš„æ˜¾ç¤ºç»¿è‰²
            const cp = parseFloat(d.summary.current_profit) || 0;
            document.getElementById('current_profit').className = `text-3xl font-bold stat-value ${cp >= 0 ? 'text-green-400' : 'text-red-400'}`;

            // ğŸš€ ROI é¢œè‰²ï¼š>20% ç»¿è‰²ä¼˜ç§€ï¼Œ5-20% ç´«è‰²æ­£å¸¸ï¼Œ<5% çº¢è‰²è­¦ç¤º
            const roiVal = parseFloat(rawSoldRoi) || 0;
            let roiColor = "text-purple-400";
            if (roiVal > 20) roiColor = "text-green-400";
            else if (roiVal < 5) roiColor = "text-red-400";
            document.getElementById('sold_roi').className = `text-3xl font-bold stat-value ${roiColor}`;
            // æ¸²æŸ“è¡¨æ ¼ (åªæ›¿æ¢ tbody å†…éƒ¨ï¼Œä¸é—ªçƒ)
            const agingBody = document.getElementById('aging_body');
            agingBody.innerHTML = d.details.on_shelf_aging.map(item => `
                <tr class="border-b border-gray-800 hover:bg-gray-800/50 transition-all duration-300">
                    <td class="py-4 font-medium text-gray-300">${item.name}</td>
                    <td class="py-4 text-blue-400 font-mono">Â¥${item.price}</td>
                    <td class="py-4 text-right font-bold ${item.days > 7 ? 'text-red-500' : (item.days > 3 ? 'text-yellow-500' : 'text-green-500')}">${item.days} å¤©</td>
                </tr>`).join('');

            // ğŸš€ æ¸²æŸ“å¾…å”®å•†å“ï¼ˆå¸¦ä¸Šæ¶æŒ‰é’®ï¼‰
            const missingBody = document.getElementById('missing_body');
            const missingList = d.details.missing_from_steampy || [];

            // æ›´æ–°å¾…å”®å•†å“è®¡æ•°
            document.getElementById('missing_count').innerText = `${missingList.length} ä¸ª`;

            if (missingList.length === 0) {
                missingBody.innerHTML = '<div class="text-green-500 text-sm italic">âœ¨ ä»“åº“å·²æ¸…ç©ºï¼Œå…¨éƒ¨å•†å“å·²åœ¨å”®</div>';
            } else {
                // ä» trace_details ä¸­æ‰¾åˆ°å¯¹åº”çš„å®Œæ•´ä¿¡æ¯
                const traceDetails = d.details.trace_details || [];
                missingBody.innerHTML = missingList.map(name => {
                    // åœ¨ trace_details ä¸­æŸ¥æ‰¾å¯¹åº”çš„å•†å“
                    const item = traceDetails.find(t => t.source_name === name && t.tag === 'é—ç ');
                    const uid = item ? item.uid : '';
                    const cost = item ? item.cost : 0;

                    return `
                    <div class="p-3 bg-yellow-900/10 border border-yellow-900/20 rounded text-sm text-yellow-200 flex items-center justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium truncate" title="${name}">ğŸŸ¡ ${name}</div>
                            <div class="text-xs text-gray-500 mt-1">ğŸ’° æˆæœ¬ï¼šÂ¥${cost?.toFixed(2) || '0.00'}</div>
                            <div class="text-xs text-gray-600 mt-0.5 font-mono">ID: ${uid}</div>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <button onclick="listSingleItem('${encodeURIComponent(uid)}', '${encodeURIComponent(name)}', ${cost || 0})"
                                    class="px-3 py-1.5 bg-green-700 hover:bg-green-600 disabled:bg-gray-700 disabled:cursor-not-allowed rounded text-xs transition flex items-center gap-1"
                                    title="æŸ¥è¯¢ SteamPy ä»·æ ¼å¹¶ä¸Šæ¶æ­¤å•†å“">
                                ğŸš€ ä¸Šæ¶æ­¤é¡¹
                            </button>
                            <button onclick="markAsDamaged('${encodeURIComponent(uid)}', '${encodeURIComponent(name)}')"
                                    class="px-3 py-1.5 bg-red-900/50 hover:bg-red-800 rounded text-xs transition"
                                    title="æ ‡è®°ä¸ºæŸæ¯ï¼Œåªè®°æˆæœ¬">
                                ğŸš« æ ‡è®°æŸæ¯
                            </button>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            // ğŸš€ æ¸²æŸ“å…¨æ¯èµ„äº§æº¯æºæ¸…å•ï¼ˆäº¤æ˜“æ˜ç»†ï¼‰
            const traceBody = document.getElementById('trace_body');
            const traceDetails = d.details.trace_details || [];
            
            // ğŸš€ ç¨³å®šæ’åºï¼šä¸»é”®ä¸ºçŠ¶æ€ï¼Œæ¬¡é”®ä¸ºé‡‡è´­æˆæœ¬ï¼ˆé™åºï¼‰ï¼Œå†æ¬¡é”®ä¸ºåç§°ï¼ˆå­—å…¸åºï¼‰
            const sortedDetails = [...traceDetails].sort((a, b) => {
                const order = { "å·²å”®": 0, "åœ¨å”®": 1, "å¾…å”®": 2, "æ¥æºä¸æ˜": 3 };
                const statusDiff = (order[a.tag] ?? 99) - (order[b.tag] ?? 99);
                if (statusDiff !== 0) return statusDiff;
                // çŠ¶æ€ç›¸åŒæ—¶ï¼ŒæŒ‰æˆæœ¬é™åºæ’åˆ—
                const costDiff = b.cost - a.cost;
                if (Math.abs(costDiff) > 0.01) return costDiff;
                // æˆæœ¬ä¹Ÿç›¸åŒæ—¶ï¼ŒæŒ‰åç§°å­—å…¸åºæ’åˆ—ï¼ˆç¡®ä¿ç¨³å®šæ€§ï¼‰
                return a.source_name.localeCompare(b.source_name, 'zh-Hans-CN');
            });

            traceBody.innerHTML = sortedDetails.map(item => {
                // çŠ¶æ€æ ‡ç­¾æ ·å¼
                const tagStyles = {
                    "å·²å”®": "bg-green-900/30 text-green-400 border-green-800",
                    "åœ¨å”®": "bg-blue-900/30 text-blue-400 border-blue-800",
                    "å¾…å”®": "bg-yellow-900/30 text-yellow-400 border-yellow-800",
                    "æ¥æºä¸æ˜": "bg-purple-900/30 text-purple-400 border-purple-800"
                };
                const tagStyle = tagStyles[item.tag] || "bg-gray-800 text-gray-400";

                // ğŸš€ ç›ˆäºæ ·å¼ï¼šprofit æ°¸è¿œæ˜¯æ•°å­—
                const profitVal = parseFloat(item.profit);
                let profitClass = "text-gray-400";
                let profitDisplay = `Â¥${profitVal.toFixed(2)}`;

                if (profitVal > 0) profitClass = "text-green-400 font-bold";
                else if (profitVal < 0) profitClass = "text-red-400 font-bold";

                // ğŸš€ çŠ¶æ€æ˜¾ç¤ºï¼šæŠŠ"é—ç "æ”¹æˆ"å¾…å”®"
                const displayTag = item.tag === 'é—ç ' ? 'å¾…å”®' : item.tag;

                return `
                <tr class="border-b border-gray-800 hover:bg-gray-800/50 transition-all duration-200">
                    <td class="py-3">
                        <span class="px-2 py-1 rounded text-xs border ${tagStyle}">${displayTag}</span>
                    </td>
                    <td class="py-3 font-medium text-gray-300">${item.source_name}</td>
                    <td class="py-3 text-gray-500 text-sm">${item.mapped_name !== item.source_name ? item.mapped_name : '-'}</td>
                    <td class="py-3 text-right text-red-400 font-mono">Â¥${item.cost.toFixed(2)}</td>
                    <td class="py-3 text-right text-blue-400 font-mono">Â¥${item.est_revenue.toFixed(2)}</td>
                    <td class="py-3 text-right font-mono ${profitClass}">${profitDisplay}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="6" class="py-8 text-center text-gray-500">ğŸ“Š æš‚æ— äº¤æ˜“è®°å½•</td></tr>';

        } catch (e) {
            console.warn("ğŸ“¡ ä¿¡å·å¹²æ‰°ä¸­ï¼Œæ­£åœ¨ç»´æŒå½“å‰å…¨æ¯æŠ•å½±...");
        }
    }

    // ğŸš€ ä¸€é”®ä¸Šæ¶åŠŸèƒ½
    let autoListInProgress = false;

    // ğŸš€ å•ä¸ªå•†å“ä¸Šæ¶å‡½æ•°
    async function listSingleItem(uid, name, cost) {
        if (autoListInProgress) {
            alert("â³ ä¸Šæ¶ä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...");
            return;
        }

        const confirmMsg = `ğŸš€ å‡†å¤‡ä¸Šæ¶ï¼š${name}\n\nç³»ç»Ÿå°†ï¼š\n1. æŸ¥è¯¢ SteamPy å¸‚åœºä»·æ ¼\n2. ä»¥ç•¥ä½äºå¸‚åœºçš„ä»·æ ¼è‡ªåŠ¨ä¸Šæ¶\n3. å‘é€é£ä¹¦é€šçŸ¥\n\nğŸ’° é‡‡è´­æˆæœ¬ï¼šÂ¥${cost}\nğŸ†” å•†å“ ID: ${uid}\n\nâš ï¸ æ³¨æ„ï¼šåˆ©æ¶¦ä¸è¶³æˆ–ä¼šäºæœ¬çš„å•†å“å°†è‡ªåŠ¨è·³è¿‡\n\nç¡®è®¤ç»§ç»­ï¼Ÿ`;
        if (!confirm(confirmMsg)) {
            return;
        }

        // ç¦ç”¨æ‰€æœ‰ä¸Šæ¶æŒ‰é’®
        const allButtons = document.querySelectorAll('button[onclick^="listSingleItem"]');
        allButtons.forEach(btn => {
            btn.disabled = true;
            btn.innerHTML = "â³ ä¸Šæ¶ä¸­...";
        });

        autoListInProgress = true;

        try {
            const headers = API_TOKEN ? { 'Authorization': `Bearer ${API_TOKEN}` } : {};

            const res = await fetch('/api/list_single_item', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...headers
                },
                body: JSON.stringify({
                    uid: decodeURIComponent(uid),
                    name: decodeURIComponent(name),
                    cost: parseFloat(cost)
                    // ğŸš¨ CDKey ç”±åç«¯ä»é‡‡è´­è´¦æœ¬ä¸­æŸ¥æ‰¾ï¼Œä¸ç»è¿‡å‰ç«¯
                })
            });

            const result = await res.json();

            if (result.success) {
                if (result.status === "success") {
                    // ä¸Šæ¶æˆåŠŸï¼Œæ˜¾ç¤ºæ¶ˆæ¯å¹¶åˆ·æ–°é¡µé¢
                    const statusMsg = `âœ… ä¸Šæ¶æˆåŠŸï¼\n\nğŸ“Š ä¸Šæ¶ä¿¡æ¯ï¼š\nâ”œâ”€ ä»·æ ¼ï¼šÂ¥${result.listing_price}\nâ”œâ”€ é¢„æœŸåˆ©æ¶¦ï¼šÂ¥${result.profit}\nâ””â”€ åŒ¹é…åï¼š${result.market_name}\n\nâ³ æ•°æ®å·²è‡ªåŠ¨åŒæ­¥ï¼Œç‚¹å‡»ç¡®å®šååˆ·æ–°é¡µé¢...`;
                    alert(statusMsg);
                    // ç”¨æˆ·ç‚¹å‡»ç¡®å®šåç«‹å³åˆ·æ–°
                    location.reload();
                    return;
                } else if (result.status.includes("skipped")) {
                    // è¢«è·³è¿‡
                    alert(`â­ï¸ å·²è·³è¿‡\n\nğŸ“ åŸå› ï¼š${result.message}`);
                    location.reload();
                    return;
                } else {
                    // å…¶ä»–çŠ¶æ€
                    alert(`â„¹ï¸ å¤„ç†å®Œæˆ\n\nğŸ“ çŠ¶æ€ï¼š${result.status}\nğŸ“ è¯¦æƒ…ï¼š${result.message}`);
                    location.reload();
                    return;
                }
            } else {
                // ä¸Šæ¶å¤±è´¥
                alert(`âŒ ä¸Šæ¶å¤±è´¥ï¼š${result.message}`);
            }
        } catch (e) {
            console.error("ä¸Šæ¶å¼‚å¸¸:", e);
            alert(`âŒ è¯·æ±‚å¤±è´¥ï¼š${e.message}`);
        } finally {
            // åªæœ‰å‡ºé”™æ—¶æ‰æ¢å¤æŒ‰é’®ï¼ˆæˆåŠŸ/è·³è¿‡éƒ½ä¼šåˆ·æ–°é¡µé¢ï¼‰
            const allButtons = document.querySelectorAll('button[onclick^="listSingleItem"]');
            allButtons.forEach(btn => {
                btn.disabled = false;
                btn.innerHTML = "ğŸš€ ä¸Šæ¶æ­¤é¡¹";
            });
        }
    }

    // ğŸš« æ ‡è®°æŸæ¯å‡½æ•°
    async function markAsDamaged(uid, name) {
        const confirmMsg = `ğŸš« ç¡®è®¤æ ‡è®°ä¸ºæŸæ¯ï¼Ÿ\n\næ¸¸æˆï¼š${name}\nğŸ†” å•†å“ ID: ${uid}\n\næ ‡è®°ä¸ºæŸæ¯åï¼š\nâ”œâ”€ åªè®°å½•æˆæœ¬\nâ”œâ”€ ä¸å…è®¸ä¸Šæ¶\nâ””â”€ åœ¨è´¢åŠ¡æŠ¥è¡¨ä¸­å•ç‹¬æ˜¾ç¤º\n\nç¡®è®¤ç»§ç»­ï¼Ÿ`;
        if (!confirm(confirmMsg)) {
            return;
        }

        try {
            const headers = API_TOKEN ? { 'Authorization': `Bearer ${API_TOKEN}` } : {};

            const res = await fetch('/api/mark_damaged', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...headers
                },
                body: JSON.stringify({
                    uid: decodeURIComponent(uid),
                    name: decodeURIComponent(name)
                    // ğŸš¨ CDKey ç”±åç«¯ä»é‡‡è´­è´¦æœ¬ä¸­æŸ¥æ‰¾ï¼Œä¸ç»è¿‡å‰ç«¯
                })
            });

            const result = await res.json();

            if (result.success) {
                alert(`âœ… å·²æ ‡è®°ä¸ºæŸæ¯\n\n${result.message}`);
                setTimeout(() => location.reload(), 1000);
            } else {
                alert(`âŒ æ ‡è®°å¤±è´¥ï¼š${result.message}`);
            }
        } catch (e) {
            console.error("æ ‡è®°æŸæ¯å¼‚å¸¸:", e);
            alert(`âŒ è¯·æ±‚å¤±è´¥ï¼š${e.message}`);
        }
    }

    async function autoListMissing() {
        if (autoListInProgress) {
            alert("â³ ä¸Šæ¶ä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...");
            return;
        }

        const missingCount = parseInt(document.getElementById('missing_count').innerText) || 0;
        if (missingCount === 0) {
            alert("âœ¨ æ²¡æœ‰å¾…ä¸Šæ¶å•†å“");
            return;
        }

        const confirmMsg = `ğŸš€ å‡†å¤‡ä¸Šæ¶ ${missingCount} ä¸ªå¾…å”®å•†å“\n\nç³»ç»Ÿå°†ï¼š\n1. æŸ¥è¯¢ SteamPy å¸‚åœºä»·æ ¼\n2. ä»¥ç•¥ä½äºå¸‚åœºçš„ä»·æ ¼è‡ªåŠ¨ä¸Šæ¶\n3. å‘é€é£ä¹¦é€šçŸ¥\n\nâš ï¸ æ³¨æ„ï¼šåˆ©æ¶¦ä¸è¶³æˆ–ä¼šäºæœ¬çš„å•†å“å°†è‡ªåŠ¨è·³è¿‡\n\nç¡®è®¤ç»§ç»­ï¼Ÿ`;
        if (!confirm(confirmMsg)) {
            return;
        }

        const btn = document.getElementById('auto_list_btn');
        const originalText = btn.innerHTML;

        try {
            autoListInProgress = true;
            btn.disabled = true;
            btn.innerHTML = "â³ ä¸Šæ¶ä¸­...";
            btn.classList.add('opacity-50');

            const headers = API_TOKEN ? { 'Authorization': `Bearer ${API_TOKEN}` } : {};

            const res = await fetch('/api/auto_list', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...headers
                },
                body: JSON.stringify({})
            });

            const result = await res.json();

            if (result.success) {
                const summary = `
âœ… ä¸Šæ¶å®Œæˆï¼

ğŸ“Š æ±‡æ€»æŠ¥å‘Šï¼š
â”œâ”€ æ€»å¤„ç†ï¼š${result.total || 0} ä¸ª
â”œâ”€ æˆåŠŸä¸Šæ¶ï¼š${result.success_count || 0} ä¸ª
â”œâ”€ ä¸Šæ¶å¤±è´¥ï¼š${result.failed_count || 0} ä¸ª
â””â”€ è‡ªåŠ¨è·³è¿‡ï¼š${result.skipped_count || 0} ä¸ª

ğŸ’¡ è¯·æŸ¥çœ‹é£ä¹¦é€šçŸ¥è·å–è¯¦ç»†ä¿¡æ¯
                `.trim();
                alert(summary);

                // è‡ªåŠ¨åˆ·æ–°é¡µé¢
                setTimeout(() => location.reload(), 1000);
            } else {
                alert(`âŒ ä¸Šæ¶å¤±è´¥ï¼š${result.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
        } catch (e) {
            console.error("è‡ªåŠ¨ä¸Šæ¶å¼‚å¸¸:", e);
            alert(`âŒ è¯·æ±‚å¤±è´¥ï¼š${e.message}`);
        } finally {
            autoListInProgress = false;
            btn.disabled = false;
            btn.innerHTML = originalText;
            btn.classList.remove('opacity-50');
        }
    }

    // ğŸ“Š ä¸Šæ¬¡çš„ trace_detailsï¼ˆç”¨äºè®¡ç®—å¢é‡ï¼‰
    let lastTraceDetails = [];

    // ğŸš€ è®¡ç®—å¢é‡ä¿¡æ¯
    function calculateDelta(d) {
        const currentDetails = d.details.trace_details || [];
        const delta = {
            new_purchases: [],  // æ–°å¢é‡‡è´­
            new_listings: [],   // æ–°å¢ä¸Šæ¶
            new_sales: []       // æ–°å–å‡º
        };

        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆ·æ–°ï¼Œä¸è®¡ç®—å¢é‡
        if (lastTraceDetails.length === 0) {
            lastTraceDetails = currentDetails;
            return delta;
        }

        // åˆ›å»ºä¸Šæ¬¡çš„ç´¢å¼•
        const lastIndex = new Map();
        lastTraceDetails.forEach(item => {
            lastIndex.set(item.uid, item);
        });

        // éå†å½“å‰æ•°æ®ï¼Œæ‰¾å‡ºæ–°å¢é¡¹
        currentDetails.forEach(item => {
            if (!lastIndex.has(item.uid)) {
                // æ–°å¢çš„é¡¹ç›®
                if (item.tag === "é—ç " || item.tag === "å¾…å”®") {
                    delta.new_purchases.push({
                        name: item.source_name,
                        cost: item.cost
                    });
                } else if (item.tag === "åœ¨å”®") {
                    delta.new_listings.push({
                        name: item.source_name,
                        price: item.est_revenue
                    });
                } else if (item.tag === "å·²å”®") {
                    delta.new_sales.push({
                        name: item.source_name,
                        price: item.est_revenue
                    });
                }
            }
        });

        // æ›´æ–°ä¸Šæ¬¡çš„ trace_details
        lastTraceDetails = currentDetails;

        return delta;
    }

    // ğŸš€ åˆ·æ–°æ•°æ®å‡½æ•°ï¼ˆæ‰‹åŠ¨/è‡ªåŠ¨å…±ç”¨ï¼‰
    async function refreshAuditData(showLoading = true) {
        try {
            const headers = API_TOKEN ? { 'Authorization': `Bearer ${API_TOKEN}` } : {};

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆä»…æ‰‹åŠ¨åˆ·æ–°æ—¶æ˜¾ç¤ºï¼‰
            if (showLoading) {
                const refreshBtn = document.querySelector('button[onclick="refreshAuditData()"]');
                if (refreshBtn) {
                    const originalText = refreshBtn.innerHTML;
                    refreshBtn.disabled = true;
                    refreshBtn.innerHTML = "â³ åˆ·æ–°ä¸­...";

                    setTimeout(() => {
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = "ğŸ”„ åˆ·æ–°æ•°æ®";
                    }, 3000);
                }
            }

            const res = await fetch('/api/audit_stats', { headers });

            if (res.status === 401) {
                // Token å¤±æ•ˆï¼Œåˆ·æ–°é¡µé¢é‡æ–°è®¤è¯
                location.reload();
                return;
            }

            if (!res.ok) throw new Error("ç½‘ç»œå“åº”å¼‚å¸¸");
            const d = await res.json();

            // ğŸ›¡ï¸ æ£€æµ‹æ•°æ®æ˜¯å¦æ›´æ–°
            if (d.update_at === lastUpdateAt) {
                console.log("âœ… æ•°æ®æœªæ›´æ–°ï¼Œè·³è¿‡åˆ·æ–°");
                if (showLoading) {
                    alert("âœ… æ•°æ®å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åˆ·æ–°");
                }
                return;
            }

            console.log(`ğŸš€ æ£€æµ‹åˆ°æ–°æ•°æ® [${d.update_at}]ï¼Œæ­£åœ¨æ›´æ–°è§†å›¾...`);
            lastUpdateAt = d.update_at;

            // âœ… è°ƒç”¨ loadAudit() è¿›è¡Œæ— æ„Ÿæ›´æ–°ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ·æ–°é¡µé¢
            await loadAudit();

            // ğŸš€ å‘é€é£ä¹¦é€šçŸ¥ï¼ˆä»…æ‰‹åŠ¨åˆ·æ–°æ—¶å‘é€ï¼‰
            if (showLoading) {
                try {
                    // è®¡ç®—å¢é‡ä¿¡æ¯
                    constå¢é‡ä¿¡æ¯ = calculateDelta(d);

                    await fetch('/api/notify_refresh', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...headers
                        },
                        body: JSON.stringify({
                            update_at: d.update_at,
                            total_investment: d.summary.total_investment,
                            current_profit: d.summary.current_profit,
                            expected_profit: d.summary.expected_profit,
                            realized_cash: d.summary.realized_cash,
                            details: å¢é‡ä¿¡æ¯
                        })
                    });
                } catch (e) {
                    console.warn("ğŸ“¡ é£ä¹¦é€šçŸ¥å‘é€å¤±è´¥:", e);
                }
            }

        } catch (e) {
            console.warn("ğŸ“¡ åˆ·æ–°å¤±è´¥:", e);
            if (showLoading) {
                alert("âŒ åˆ·æ–°å¤±è´¥ï¼š" + e.message);
            }
        }
    }

    // ğŸš€ åˆå§‹åŒ–æ¯èˆ°æ§åˆ¶å°
    window.onload = () => {
        // è¿›é¡µé¢å…ˆåŠ è½½ä¸€æ¬¡æ•°æ®ï¼ˆä¸åˆ·æ–°é¡µé¢ï¼Œåªæ›´æ–°å†…å®¹ï¼‰
        loadAudit();

        // â° å®šæ—¶åˆ·æ–°ï¼šæ¯ 6 å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ•°æ®æ›´æ–°
        // 6 å°æ—¶ = 6 * 60 * 60 * 1000 = 21600000ms
        setInterval(() => refreshAuditData(false), 21600000);

        console.log("ğŸ“Š å®¡è®¡çœ‹æ¿å·²å¯åŠ¨ï¼Œæ¯ 6 å°æ—¶è‡ªåŠ¨æ£€æŸ¥æ•°æ®æ›´æ–°");
    };
    </script>
</body>
</html>
