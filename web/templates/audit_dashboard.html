<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>SENTINEL | 财务资产审计看板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; }
        .glass-card { background: #161b22; border: 1px solid #30363d; border-radius: 12px; }
        .stat-value { font-family: 'Segoe UI', monospace; }
    </style>
</head>
<body class="p-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-end mb-8 border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">📊 母舰资产全息审计</h1>
                <p class="text-gray-500 mt-1" id="update_time">正在连接母舰数据库...</p>
            </div>
            <button onclick="location.reload()" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded text-sm transition">🔄 刷新数据</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-card p-6 border-l-4 border-l-red-500">
                <div class="text-gray-500 text-xs uppercase mb-1">采购总成本</div>
                <div id="total_investment" class="text-3xl font-bold stat-value">¥ 0.00</div>
            </div>
            <div class="glass-card p-6 border-l-4 border-l-green-500">
                <div class="text-gray-500 text-xs uppercase mb-1 font-bold">💰 当前已实现利润</div>
                <div id="current_profit" class="text-3xl font-bold stat-value">¥ 0.00</div>
            </div>
            <div class="glass-card p-6 border-l-4 border-l-cyan-500">
                <div class="text-gray-500 text-xs uppercase mb-1 font-bold">📈 最终预期总利润</div>
                <div id="expected_profit" class="text-3xl font-bold stat-value">¥ 0.00</div>
            </div>

            <div class="glass-card p-6 border-l-4 border-l-blue-500">
                <div class="text-gray-500 text-xs uppercase mb-1">已回收现金 (到手)</div>
                <div id="realized_cash" class="text-3xl font-bold text-blue-400 stat-value">¥ 0.00</div>
            </div>
            <div class="glass-card p-6 border-l-4 border-l-blue-500">
                <div class="text-gray-500 text-xs uppercase mb-1">回本进度</div>
                <div id="recovery_rate" class="text-3xl font-bold text-blue-400 stat-value">0%</div>
            </div>
            <div class="glass-card p-6 border-l-4 border-l-yellow-500">
                <div class="text-gray-500 text-xs uppercase mb-1">货架总净值</div>
                <div id="floating_asset" class="text-3xl font-bold text-yellow-500 stat-value">¥ 0.00</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 glass-card p-6">
                <h3 class="text-lg font-bold mb-4 text-gray-300">🕒 货架账龄分析</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-gray-500 border-b border-gray-800">
                            <tr>
                                <th class="pb-3">游戏实体</th>
                                <th class="pb-3">挂单价</th>
                                <th class="pb-3 text-right">已挂时长</th>
                            </tr>
                        </thead>
                        <tbody id="aging_body"></tbody>
                    </table>
                </div>
            </div>

            <div class="glass-card p-6">
                <h3 class="text-lg font-bold mb-4 text-red-400">⚠️ 仓库遗珠 (未上架)</h3>
                <div id="missing_body" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
       // 📡 网页雷达：记录上一次母舰审计的时间戳
    let lastUpdateAt = "";

    async function loadAudit() {
        try {
            const res = await fetch('/api/audit_stats');
            if (!res.ok) throw new Error("网络响应异常");
            const d = await res.json();
            
            // 💡 核心保护 1：如果后端返回的时间戳没变，直接切断后续逻辑，网页动都不动一下
            if (lastUpdateAt === d.update_at) {
                console.log("🧊 账本未变动，保持静默...");
                return;
            }
            
            // 💡 核心保护 2：只有时间戳变了（说明后台算完新账了），才开始“贴纸”更新
            console.log(`🚀 侦测到新账本 [${d.update_at}]，正在更新视图...`);
            lastUpdateAt = d.update_at;

            // --- 以下是静默替换逻辑，不会引起白屏或归零 ---
            document.getElementById('update_time').innerText = "最后清算: " + d.update_at;
            document.getElementById('total_investment').innerText = "¥ " + d.summary.total_investment;
            document.getElementById('realized_cash').innerText = "¥ " + d.summary.realized_cash;
            document.getElementById('recovery_rate').innerText = d.summary.recovery_rate + "%";
            document.getElementById('floating_asset').innerText = "¥ " + d.summary.floating_asset;
            // 在 loadAudit 函数内的 document.getElementById 区域添加：
            document.getElementById('current_profit').innerText = "¥ " + d.summary.current_profit;
            document.getElementById('expected_profit').innerText = "¥ " + d.summary.expected_profit;

            // 顺便做个颜色高亮逻辑：如果利润是负的（还没回本），显示红色，正的显示绿色
            const cp = parseFloat(d.summary.current_profit);
            document.getElementById('current_profit').className = `text-3xl font-bold stat-value ${cp >= 0 ? 'text-green-400' : 'text-red-400'}`;
            // 渲染表格 (只替换 tbody 内部，不闪烁)
            const agingBody = document.getElementById('aging_body');
            agingBody.innerHTML = d.details.on_shelf_aging.map(item => `
                <tr class="border-b border-gray-800 hover:bg-gray-800/50 transition-all duration-300">
                    <td class="py-4 font-medium text-gray-300">${item.name}</td>
                    <td class="py-4 text-blue-400 font-mono">¥${item.price}</td>
                    <td class="py-4 text-right font-bold ${item.days > 7 ? 'text-red-500' : (item.days > 3 ? 'text-yellow-500' : 'text-green-500')}">${item.days} 天</td>
                </tr>`).join('');

            // 渲染遗珠
            const missingBody = document.getElementById('missing_body');
            missingBody.innerHTML = d.details.missing_from_steampy.map(name => `
                <div class="p-3 bg-red-900/10 border border-red-900/20 rounded text-sm text-red-200 animate-pulse">❓ ${name}</div>
            `).join('') || '<div class="text-green-500 text-sm italic">✨ 仓库已清空，全部商品已在售</div>';

        } catch (e) { 
            console.warn("📡 信号干扰中，正在维持当前全息投影..."); 
        }
    }

    // 🚀 初始化母舰控制台
    window.onload = () => {
        loadAudit(); // 进页面先抓一次
        // 缩短探测频率至 15 秒也没关系，因为这种方式不刷页面，完全无感
        setInterval(loadAudit, 15000); 
    };
    </script>
</body>
</html>