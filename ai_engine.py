import os
import time
import re
from zhipuai import ZhipuAI
from dotenv import load_dotenv

load_dotenv()

class ArbitrageAI:
    def __init__(self):
        api_key = os.getenv("ZHIPU_API_KEY")
        self.model = os.getenv("ZHIPU_MODEL", "glm-4-flash")
        self.client = ZhipuAI(api_key=api_key)

    def _call_with_retry(self, prompt, max_retries=3):
        """é€šç”¨ API è°ƒç”¨åŒ…è£…å™¨ï¼Œå¤„ç†æŒ‡æ•°é€€é¿é‡è¯•"""
        for i in range(max_retries):
            try:
                response = self.client.chat.completions.create(
                    model=self.model,
                    messages=[{"role": "user", "content": prompt}],
                    timeout=10 # å¢åŠ è¶…æ—¶æ§åˆ¶
                )
                return response.choices[0].message.content.strip()
            except Exception as e:
                err_msg = str(e)
                if "429" in err_msg or "1305" in err_msg:
                    wait_time = (i + 1) * 3 # ç¬¬ä¸€æ¬¡3s, ç¬¬äºŒæ¬¡6s, ç¬¬ä¸‰æ¬¡9s
                    print(f"â³ è§¦å‘é¢‘ç‡é™åˆ¶ï¼Œæ­£åœ¨è¿›è¡Œç¬¬ {i+1} æ¬¡æŒ‡æ•°é€€é¿ï¼Œç­‰å¾… {wait_time}s...")
                    time.sleep(wait_time)
                    continue
                print(f"âš ï¸ AI è°ƒç”¨å¼‚å¸¸: {err_msg}")
                break
        return None

    def get_search_keyword(self, raw_name):
        """æ ¸å¿ƒèƒ½åŠ› 1ï¼šé™å™ªæå–ï¼ˆæ­»å‘½ä»¤ç‰ˆï¼‰"""
        prompt = (
            "ä½ æ˜¯ä¸€ä¸ªç²¾é€š Steam æ•°æ®åº“çš„æ¸¸æˆä¸“å®¶ã€‚ä»»åŠ¡æ˜¯æå–ç”¨äºæœç´¢çš„ã€å®Œæ•´æ ¸å¿ƒåã€‘ã€‚\n\n"
            "ã€é’¢é“å¾‹ä»¤ã€‘ï¼š\n"
            "1. ä¸¥ç¦è¿›è¡Œä»»ä½•å½¢å¼çš„åˆ†è¯ç¼©å‡ï¼æ¸¸æˆåå¿…é¡»æ˜¯å®Œæ•´çš„å®ä½“ã€‚\n"
            "2. é”™è¯¯ç¤ºèŒƒï¼šæŠŠ 'ç©ºæ´éª‘å£«' æå–ä¸º 'ç©ºæ´' æ˜¯è‡´å‘½é”™è¯¯ï¼å¿…é¡»ä¿ç•™ 'ç©ºæ´éª‘å£«'ã€‚\n"
            "3. é”™è¯¯ç¤ºèŒƒï¼šæŠŠ 'ç”ŸåŒ–å±æœº' æå–ä¸º 'ç”ŸåŒ–' æ˜¯è‡´å‘½é”™è¯¯ï¼å¿…é¡»ä¿ç•™ 'ç”ŸåŒ–å±æœº'ã€‚\n"
            "4. å¿…é¡»åˆ é™¤çš„å¹²æ‰°è¯ï¼š'æ ‡å‡†ç‰ˆ'ã€'è±ªåç‰ˆ'ã€'Steamç‰ˆ'ã€'åˆ¸åä»·'ã€'æ¿€æ´»ç 'ã€'ç°è´§'ã€‚\n\n"
            "ã€ç¤ºä¾‹ã€‘ï¼š\n"
            "è¾“å…¥ï¼š'ã€ç‰¹æƒ ã€‘Hollow Knight ç©ºæ´éª‘å£« æ ‡å‡†ç‰ˆ'\n"
            "è¾“å‡ºï¼šHollow Knight ç©ºæ´éª‘å£«\n\n"
            f"è¾“å…¥æ ‡é¢˜ï¼š{raw_name}\n"
            "ä»…è¾“å‡ºç»“æœï¼ˆæ ¸å¿ƒåç§°ï¼‰ï¼Œç¦æ­¢ä»»ä½•è§£é‡Šæˆ–æ ‡ç‚¹ï¼š"
        )
        result = self._call_with_retry(prompt)
        
        # ğŸ’¡ [é€»è¾‘ä¿é™©]ï¼šå¦‚æœ AI è¿˜æ˜¯æŠ½é£æŠŠé•¿è¯å˜çŸ­è¯ï¼Œå¼ºåˆ¶å›é€€
        if result and len(raw_name) > 4 and len(result) < 3:
            print(f"âš ï¸ [AI æŠ½é£è­¦å‘Š] æå–ç»“æœè¿‡çŸ­({result})ï¼Œå¼ºåˆ¶å›é€€åŸåã€‚")
            return raw_name[:10] # æˆªå–å‰10ä½ä¿è¯æœç´¢ç²¾åº¦
            
        print(f"====AI æ€è€ƒç»“æœ===: [{result}]")
        return result if result else raw_name

    def verify_version(self, sk_name, py_name):
        """æ ¸å¿ƒèƒ½åŠ› 2ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ™ºèƒ½åˆ†æµç‰ˆï¼‰"""
        # --- ç­–ç•¥ 1ï¼šç‰©ç†å±‚å¯¹é½ï¼ˆç›´æ¥æ”¾è¿‡ï¼Œä¸èŠ±é’±ï¼‰ ---
        # 1. é™¤å»ç©ºæ ¼å’Œæ ‡ç‚¹åå®Œå…¨ä¸€è‡´
        def strict_clean(s): return re.sub(r'[ï¼š:ï¼Œ,ã€‚\.Â·ãƒ»\-\s]', '', s).lower()
        
        if strict_clean(sk_name) == strict_clean(py_name):
            print(f"âœ… å­—ç¬¦ä¸²ç‰©ç†åŒ¹é…ï¼Œç›´æ¥é€šè¿‡ã€‚")
            return True

        # --- ç­–ç•¥ 2ï¼šAI è¯­ä¹‰å±‚å¯¹é½ï¼ˆå¤„ç† XCOM 2 vs å¹½æµ®2ï¼‰ ---
        prompt = (
            "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¸¸æˆåº“ç®¡ç†ä¸“å®¶ã€‚è¯·æŒ‰ä»¥ä¸‹ä¸¥è°¨æ­¥éª¤è¯„ä¼°å•†å“ A å’Œ B æ˜¯å¦ä¸ºåŒä¸€æ¸¸æˆå®ä½“ï¼š\n\n"
            "æ­¥éª¤ 1ï¼šè¯­ä¹‰æ‹†è§£ã€‚åˆ†åˆ«æå– A å’Œ B çš„ã€æ ¸å¿ƒåç§°ã€‘ã€ã€ç³»åˆ—æ•°å­—ã€‘ã€ã€ç‰ˆæœ¬ç±»å‹ã€‘ã€‚\n"
            "æ­¥éª¤ 2ï¼šè¯­ä¹‰å¯¹é½ï¼ˆå…³é”®æ­¥éª¤ï¼‰ã€‚\n"
            "- é¦–å…ˆï¼Œè¯†åˆ« A å’Œ B æ˜¯å¦æŒ‡å‘åŒä¸€æ¸¸æˆç³»åˆ—ã€‚\n"
            "- å…¶æ¬¡ï¼Œæ¯”å¯¹ç‰ˆæœ¬å†…å®¹ã€‚**åˆ©ç”¨æ¸¸æˆé¢†åŸŸçŸ¥è¯†**åˆ¤æ–­åç¼€æ˜¯å¦å¯¹åº”ã€‚\n"
            "*ç‰¹åˆ«æ³¨æ„*ï¼šä¸­æ–‡å¸¸ä½¿ç”¨æ„è¯‘ï¼ˆå¦‚'è°œé¢˜æŒ‘æˆ˜è€…'å¯¹åº”'Puzzles'ï¼‰ï¼Œè¯·å‹¿ä»…å› å­—é¢ç¿»è¯‘ä¸åŒè€Œå¦å®šï¼Œéœ€åˆ¤æ–­å…¶æŒ‡ä»£å†…å®¹æ˜¯å¦ä¸€è‡´ã€‚\n"
            "æ­¥éª¤ 3ï¼šä¸¥æ ¼æ ¡éªŒã€‚\n"
            "- æ•°å­—/ç³»åˆ—æ ¡éªŒï¼š'æ¸¸æˆå 2' ç»ä¸ç­‰äº 'æ¸¸æˆå'ã€‚\n"
            "- ç‰ˆæœ¬ä¸€è‡´æ€§ï¼šè‹¥ A ä¸º DLC/åç¼€å†…å®¹ï¼ŒB å¿…é¡»ä¹Ÿä¸ºå¯¹åº”çš„ DLC/åç¼€å†…å®¹æ‰å¯åˆ¤å®š YESã€‚è‹¥ A æ˜¯ DLC è€Œ B ä»…æ˜¯æœ¬ä½“ï¼Œå¿…é¡»å›å¤ [NO]ã€‚\n\n"
            "åˆ¤å®šè§„åˆ™ï¼š\n"
            "- æ ¸å¿ƒåç§°ä¸€è‡´ï¼Œä¸”ç‰ˆæœ¬å†…å®¹å¯¹åº”ï¼ˆå«æ„è¯‘å¯¹åº”ï¼‰ï¼šå›å¤ [YES]ã€‚\n"
            "- æ ¸å¿ƒåç§°ä¸åŒï¼Œæˆ–ç‰ˆæœ¬å±‚çº§ä¸åŒ¹é…ï¼ˆDLC vs æœ¬ä½“ï¼‰ï¼šå›å¤ [NO]ã€‚\n\n"
            "å…¸å‹é”™è¯¯æ¡ˆä¾‹å‚è€ƒï¼ˆä¸¥ç¦æ•ˆä»¿ï¼‰ï¼š"
            "A: 'ç¯å½¢å¸å›½' | B: 'é’å²šç‰©è¯­' -> [NO] (è¯­ä¹‰å®Œå…¨æ— å…³)"
            "A: 'å¼‚å½¢å·¥å‚' | B: 'å¼‚å½¢å·¥å‚2' -> [NO] (æ•°å­—ç‰ˆæœ¬ä¸ç¬¦)"
            "A: 'å¼‚å½¢å·¥å‚' | B: 'å¼‚å½¢å·¥å‚ - è°œé¢˜æŒ‘æˆ˜è€…' -> [NO] (DLC ä¸ç­‰äºæœ¬ä½“)"
            f"å•†å“Aï¼š{sk_name}\n"
            f"å•†å“Bï¼š{py_name}\n"
            "ä»…å›å¤ [YES] æˆ– [NO]ã€‚"
        )

        
        result = self._call_with_retry(prompt)
        if result:
            return "[YES]" in result.upper()
        
        # å¤±è´¥å…œåº•
        return True
    
    # ai_engine.py å†…éƒ¨

    def quick_call(self, prompt):
        """
        æé€Ÿå®¡è®¡æ¨¡å¼ï¼šä¸è¿›è¡Œä»»ä½•é€»è¾‘åŠ å·¥ï¼Œç›´æ¥è·å– AI çš„åŸè¯ã€‚
        ç”¨äº MATCH / VERSION_ERROR / ENTITY_ERROR çš„åˆ¤å®šã€‚
        """
        try:
            # ğŸ’¡ å‡è®¾ä½ ç±»ä¸­å·²æœ‰çš„è°ƒç”¨æ–¹æ³•æ˜¯ _call_with_retry æˆ–ç±»ä¼¼
            # å¦‚æœä½ çš„æ–¹æ³•åä¸åŒï¼Œè¯·ä¿®æ”¹è¿™é‡Œ
            result = self._call_with_retry(prompt)
            
            if result:
                # ç®€å•æ¸…æ´—ï¼Œåªä¿ç•™å¤§å†™å­—æ¯ï¼Œé˜²æ­¢ AI å¤šå˜´å¸¦æ ‡ç‚¹
                import re
                clean_res = re.sub(r'[^A-Z_]', '', result.strip().upper())
                return clean_res
            return "ERROR"
        except Exception as e:
            print(f"ğŸš¨ AI å®¡è®¡è°ƒç”¨å¤±è´¥: {e}")
            return "ERROR"